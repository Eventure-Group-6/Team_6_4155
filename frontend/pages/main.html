

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Eventure ‚Äî Discover Clubs</title>

  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../assets/css/styles.css">
</head>
<body style="padding:20px;">

  <div class="main-wrap" role="main" aria-label="Main feed and navigation">
    <aside class="sidebar" aria-label="Sidebar navigation">
      <div class="brand">
        <span class="logo">Eventure</span>
        <div>
          <div style="font-weight:700">Eventure</div>
          <div class="small" style="margin-top:4px">Clubs & Events</div>
        </div>
      </div>

      <nav class="nav" aria-label="Main navigation">
        <a href="main.html" aria-current="page">Discover</a>
        <a href="#" onclick="showFeeds()">Feeds</a>
        <a href="#" onclick="showOrganizations()">Organizations</a>
        <a href="#" onclick="showMyClubs()">My Clubs</a>
        <a href="#" onclick="showEvents()">Events</a>
        <a href="#" onclick="showFavorites()">Favorites</a>
        <a href="#" onclick="showPostForm()">Post</a>
        <a href="#" onclick="showDiscussion()">Discussion</a>
        <a href="login.html">Sign out</a>
      </nav>
    </aside>

    <section class="feed" aria-label="Club poster feed" id="mainFeed">
      <div style="margin-bottom:20px;"><h2 style="color:#e6eef8;font-weight:700;margin:0 0 10px 0;">‚ú® Discover</h2><p style="color:var(--muted);margin:0;">Explore clubs and events</p></div>
      <div class="footer-note">Tip: Scroll up/down to browse ‚Äî posters snap into view for easy preview.</div>
    </section>
  </div>

<script>
  // Check authentication on page load
  async function checkAuth() {
    try {
      const response = await fetch('http://localhost:8080/api/session', {
        credentials: 'include'
      });
      const data = await response.json();
      if(!data.authenticated) {
        window.location.href = 'login.html';
      }
    } catch(error) {
      console.error('Backend offline, running in demo mode');
      // Allow access in demo mode
      const demoUser = localStorage.getItem('demoUser');
      if(!demoUser) {
        alert('Demo mode: Please create an account first');
        window.location.href = 'login.html';
      }
    }
  }
  
  // Load flyers from API with animation
  async function loadFlyers() {
    const feed = document.querySelector('.feed');
    feed.classList.add('fade-out');
    
    setTimeout(() => {
      let clubsHTML = '<div style="margin-bottom:20px;"><h2 style="color:#e6eef8;font-weight:700;margin:0 0 10px 0;">‚ú® Discover</h2><p style="color:var(--muted);margin:0;">Explore clubs and events</p></div>';
      clubsHTML += organizations.map(org => renderClubCard(org)).join('');
      
      // Add user-created posts
      createdPosts.forEach(post => {
        const org = organizations.find(o => o.name === post.org);
        const imageHTML = post.image ? `<img src="${post.image}" alt="${post.title}">` : `<div class="poster-img" style="background:linear-gradient(135deg,#bfdbfe,#ddd6fe);">üéâ ${post.title}</div>`;
        const eventButton = post.eventTime ? `<button class="icon-btn" onclick="addToEvents('${post.title}', '${post.eventTime}')">üìÖ Add Event</button>` : '';
        const titleWithOrg = org ? `<h3 style="color:#1e293b;font-weight:700;margin:0 0 12px 0;cursor:pointer;display:flex;align-items:center;gap:8px;" onclick="showOrgProfile(${org.id})"><div style="width:28px;height:28px;border-radius:6px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-size:1rem;">${org.icon}</div><span>${post.org}</span></h3><h4 style="color:#1e293b;font-weight:600;margin:5px 0 12px 0;">${post.title}</h4>` : `<h3 style="color:#1e293b;font-weight:700;margin:0 0 12px 0;">${post.title}</h3>`;
        const postHTML = `
          <article class="poster" style="background:linear-gradient(180deg,#e0f2fe,#f0f9ff);border:2px solid rgba(255,255,255,0.8);">
            <div class="meta">
              <div>
                ${titleWithOrg}
                <div class="small" style="color:#475569;">${post.org} ‚Ä¢ ${post.date}</div>
              </div>
              <div class="small" style="color:#059669;">‚ú® New</div>
            </div>
            ${imageHTML}
            <div>
              <p style="color:#475569;margin:15px 0;">${post.description}</p>
              <div class="actions">
                <div>
                  <button class="icon-btn" onclick="toggleSave(${post.id}, this)">‚ù§ Save</button>
                  ${eventButton}
                  <button class="icon-btn" onclick="shareFlyer('${post.title}')">üîó Share</button>
                </div>
                <button class="btn" onclick="openDetails('${post.title}', this)">View</button>
              </div>
            </div>
          </article>
        `;
        feed.innerHTML = postHTML + feed.innerHTML;
      });
      
      clubsHTML += `<div class="footer-note">Tip: Scroll up/down to browse ‚Äî posters snap into view for easy preview.</div>`;
      feed.innerHTML = clubsHTML;
      
      feed.classList.remove('fade-out');
      feed.classList.add('fade-in');
    }, 150);
  }
  
  function openDetails(name, element) {
    // Get card position for animation origin
    const card = element ? element.closest('.poster') : null;
    
    // Create overlay
    const overlay = document.createElement('div');
    overlay.className = 'card-overlay';
    overlay.onclick = closeDetails;
    
    // Create expanded card
    const expandedCard = document.createElement('div');
    expandedCard.className = 'expanded-card';
    expandedCard.innerHTML = `
      <button class="close-btn" id="closeBtn">√ó</button>
      <div style="margin-bottom: 25px;">
        <h2 style="color:#0f172a;font-weight:800;font-size:1.8rem;margin-bottom:8px;">${name}</h2>
        <div style="color:#64748b;font-weight:600;font-size:1rem;">Event Details</div>
      </div>
      
      <div style="background:linear-gradient(135deg,#c7f9e1,#bfdbfe);border-radius:16px;padding:45px;text-align:center;margin:25px 0;border:2px solid rgba(255,255,255,0.8);">
        <div style="font-size:3.5rem;margin-bottom:15px;">üéâ</div>
        <h3 style="color:#0f172a;font-weight:700;font-size:1.4rem;">${name}</h3>
      </div>
      
      <div style="margin:25px 0;">
        <h4 style="color:#0f172a;font-weight:700;font-size:1.2rem;margin-bottom:15px;">About This Event</h4>
        <p style="color:#374151;line-height:1.7;font-size:1rem;font-weight:500;">
          ${name === 'Data Science Society' ? 'Dive into the world of data science with hands-on workshops covering Python, R, machine learning algorithms, and data visualization. Work on real-world projects, participate in Kaggle competitions, and connect with industry professionals. Whether you\'re a beginner or advanced, we have something for everyone!' : 
            name === 'Fencing Club' ? 'Experience the elegance and intensity of fencing! Our club welcomes all skill levels from complete beginners to competitive fencers. Learn foil, √©p√©e, and sabre techniques from certified coaches. Equipment is provided for newcomers. Join our team for local and regional tournaments, or just fence for fun and fitness!' :
            name === 'Association of Computing Machinery' ? 'ACM is the premier computing organization on campus. Attend weekly tech talks from industry leaders, participate in hackathons, work on open-source projects, and prepare for technical interviews. Network with recruiters from top tech companies and collaborate on innovative software projects with fellow members.' :
            name === 'Niner Game Development' ? 'Niner Game Development brings together aspiring game developers, artists, and designers. We organize weekly game jams, Unity and Unreal Engine workshops, and collaborative project teams. Members learn game design principles, programming patterns, 3D modeling, and animation. Join us to build indie games or prepare for careers at major studios!' :
            name === 'The Guild' ? 'The Guild is your friendly neighborhood board game club where students gather to unwind, strategize, and have fun. We play everything from classic favorites like Settlers of Catan and Ticket to Ride to modern strategy games and party games. No experience needed - we teach new players and welcome all skill levels. Snacks and drinks provided every session.' :
            name === 'Niner Notes' ? 'Niner Notes is the premier music production club on campus where aspiring producers, beatmakers, and audio engineers come together to create original music. Our weekly sessions cover everything from basic DAW operation to advanced mixing and mastering techniques. Members have access to professional-grade equipment and software.' :
            'An exciting event you won\'t want to miss! Join us for a great time with fellow students.'}
        </p>
      </div>
      
      <div style="margin:25px 0;background:rgba(248,250,252,0.8);padding:20px;border-radius:12px;border:1px solid rgba(226,232,240,0.8);">
        <h4 style="color:#0f172a;font-weight:700;font-size:1.2rem;margin-bottom:15px;">Event Details</h4>
        <div style="color:#374151;font-weight:500;">
          <p style="margin:8px 0;font-size:1rem;"><strong style="color:#1e293b;">When:</strong> ${name === 'Data Science Society' ? 'Tuesdays 5:30 PM' : name === 'Fencing Club' ? 'Mondays & Thursdays 6:00 PM' : name === 'Association of Computing Machinery' ? 'Wednesdays 7:00 PM' : name === 'Niner Game Development' ? 'Wednesdays 6:00 PM' : name === 'The Guild' ? 'Fridays 3:00 PM - 6:00 PM' : name === 'Niner Notes' ? 'Thursdays 6:00 PM' : 'TBD'}</p>
          <p style="margin:8px 0;font-size:1rem;"><strong style="color:#1e293b;">Where:</strong> ${name === 'Data Science Society' ? 'Woodward Hall 335' : name === 'Fencing Club' ? 'Recreation Center Gym 2' : name === 'Association of Computing Machinery' ? 'Student Union 340' : name === 'Niner Game Development' ? 'College of Computing and Informatics Room 223' : name === 'The Guild' ? 'CHHS 128' : name === 'Niner Notes' ? 'Atkins G35' : 'Student Union Building'}</p>
          <p style="margin:8px 0;font-size:1rem;"><strong style="color:#1e293b;">Cost:</strong> Free for students</p>
        </div>
      </div>
      
      <div style="display:flex;gap:12px;margin-top:35px;">
        ${(name === 'Data Science Society' || name === 'Fencing Club' || name === 'Association of Computing Machinery' || name === 'Niner Game Development' || name === 'The Guild' || name === 'Niner Notes') ? `<button class="btn" style="flex:1;font-weight:600;" onclick="addToEvents('${name}', '${name === 'Data Science Society' ? 'Tuesdays 5:30 PM' : name === 'Fencing Club' ? 'Mondays & Thursdays 6:00 PM' : name === 'Association of Computing Machinery' ? 'Wednesdays 7:00 PM' : name === 'Niner Game Development' ? 'Wednesdays 6:00 PM' : name === 'The Guild' ? 'Fridays 3:00 PM - 6:00 PM' : 'Thursdays 6:00 PM'}'); closeDetails();">Add Event</button>` : ''}
        <button class="icon-btn" style="font-weight:600;">‚ù§ Save</button>
        <button class="icon-btn" style="font-weight:600;" onclick="shareFlyer('${name}')">üîó Share</button>
      </div>
      
      <div style="margin-top:35px;border-top:2px solid rgba(226,232,240,0.8);padding-top:25px;">
        <h4 style="color:#0f172a;font-weight:700;font-size:1.2rem;margin-bottom:15px;">üí¨ Comments</h4>
        <form onsubmit="postComment(event, '${name}')" style="margin-bottom:20px;">
          <textarea placeholder="Add a comment..." required style="width:100%;min-height:80px;padding:12px;border-radius:10px;border:1px solid rgba(0,0,0,0.15);background:rgba(255,255,255,0.9);color:#1e293b;resize:vertical;font-family:inherit;margin-bottom:10px;"></textarea>
          <button type="submit" class="btn">Post Comment</button>
        </form>
        <div id="commentsSection" style="max-height:300px;overflow-y:auto;">
          <p style="color:#64748b;text-align:center;padding:20px 0;">No comments yet. Be the first to comment!</p>
        </div>
      </div>
    `;
    
    // Add to DOM
    document.body.appendChild(overlay);
    document.body.appendChild(expandedCard);
    
    // Add close button event listener
    const closeBtn = expandedCard.querySelector('#closeBtn');
    closeBtn.addEventListener('click', closeDetails);
    
    // Trigger animation
    setTimeout(() => {
      overlay.classList.add('show');
      expandedCard.classList.add('show');
    }, 10);
  }
  
  function closeDetails() {
    const overlay = document.querySelector('.card-overlay');
    const expandedCard = document.querySelector('.expanded-card');
    
    if (overlay && expandedCard) {
      overlay.classList.remove('show');
      expandedCard.classList.remove('show');
      
      setTimeout(() => {
        overlay.remove();
        expandedCard.remove();
      }, 300);
    }
  }


  
  // Logout functionality
  document.querySelector('a[href="login.html"]').addEventListener('click', async function(e) {
    e.preventDefault();
    try {
      await fetch('http://localhost:8080/api/logout', {
        method: 'POST',
        credentials: 'include'
      });
    } catch(error) {
      console.error('Logout error:', error);
    }
    window.location.href = 'login.html';
  });
  
  // Tab functionality with animations
  function showMyClubs() {
    const feed = document.querySelector('.feed');
    feed.classList.add('fade-out');
    
    setTimeout(() => {
      const followedClubs = organizations.filter(org => followedOrgs.includes(org.id));
      
      let clubsHTML = '<div style="margin-bottom:20px;"><h2 style="color:#e6eef8;font-weight:700;margin:0 0 10px 0;">‚≠ê My Clubs</h2><p style="color:var(--muted);margin:0;">Organizations you follow</p></div>';
      
      if (followedClubs.length === 0) {
        clubsHTML += `
          <div class="poster" style="background:linear-gradient(180deg,#ffffff,#f1f5f9);border:2px solid rgba(255,255,255,0.8);text-align:center;padding:40px;">
            <h3 style="color:#1e293b;margin-bottom:15px;">‚≠ê No Clubs Yet</h3>
            <p style="color:#475569;margin:20px 0;">No clubs followed yet. Follow clubs from the Organizations tab!</p>
            <button class="btn" onclick="showOrganizations()">Browse Organizations</button>
          </div>
        `;
      } else {
        followedClubs.forEach(club => {
          clubsHTML += `
            <article class="poster" style="background:linear-gradient(180deg,#fff4f2,#fff7f0);border:2px solid rgba(255,255,255,0.8);padding:20px;">
              <div style="display:flex;align-items:center;gap:15px;margin-bottom:12px;">
                <div style="width:60px;height:60px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-size:2rem;flex-shrink:0;cursor:pointer;" onclick="showOrgProfile(${club.id})">${club.icon}</div>
                <div style="flex:1;cursor:pointer;" onclick="showOrgProfile(${club.id})">
                  <h4 style="color:#1e293b;font-weight:700;margin:0 0 5px 0;">${club.name}</h4>
                  <div class="small" style="color:#475569;font-weight:500;">${club.category} ‚Ä¢ ${club.members} members</div>
                </div>
                <button class="btn" onclick="toggleFollow(${club.id}, true); showMyClubs();" style="background:rgba(255,255,255,0.8);color:#374151;border:1px solid rgba(0,0,0,0.15);">Unfollow</button>
              </div>
              <p style="color:#475569;font-weight:500;margin:0;cursor:pointer;" onclick="showOrgProfile(${club.id})">${club.description}</p>
            </article>
          `;
        });
      }
      
      feed.innerHTML = clubsHTML;
      feed.classList.remove('fade-out');
      feed.classList.add('fade-in');
    }, 150);
  }
  
  function showPostForm() {
    const feed = document.querySelector('.feed');
    feed.classList.add('fade-out');
    
    setTimeout(() => {
      feed.innerHTML = `
        <div style="margin-bottom:20px;"><h2 style="color:#e6eef8;font-weight:700;margin:0 0 10px 0;">‚ûï Post</h2><p style="color:var(--muted);margin:0;">Create a new flyer</p></div>
        <div class="poster" style="background:linear-gradient(180deg,#ffffff,#f1f5f9);border:2px solid rgba(255,255,255,0.8);">
          <h3 style="color:#1e293b;font-weight:700;">üé® Create New Flyer</h3>
          <form onsubmit="createFlyer(event)" id="flyerForm">
            <input type="text" placeholder="Event Title" required class="input" style="width:100%;margin:10px 0;background:rgba(255,255,255,0.9);border:1px solid rgba(0,0,0,0.2);color:#1e293b;">
            <input type="text" placeholder="Organization Name" required class="input" style="width:100%;margin:10px 0;background:rgba(255,255,255,0.9);border:1px solid rgba(0,0,0,0.2);color:#1e293b;">
            <textarea placeholder="Event Description" required class="input" style="width:100%;margin:10px 0;height:120px;resize:vertical;background:rgba(255,255,255,0.9);border:1px solid rgba(0,0,0,0.2);color:#1e293b;"></textarea>
            <input type="date" required class="input" style="width:100%;margin:10px 0;background:rgba(255,255,255,0.9);border:1px solid rgba(0,0,0,0.2);color:#1e293b;">
            <label style="display:block;color:#1e293b;font-weight:500;margin:10px 0 5px 0;">Event Details (optional)</label>
            <input type="text" placeholder="Event Time (e.g., Mondays 6:00 PM)" id="eventTime" class="input" style="width:100%;margin:10px 0;background:rgba(255,255,255,0.9);border:1px solid rgba(0,0,0,0.2);color:#1e293b;">
            <label style="display:block;color:#1e293b;font-weight:500;margin:10px 0 5px 0;">Attach Image (optional)</label>
            <input type="file" accept="image/*" id="imageUpload" class="input" style="width:100%;margin:10px 0;background:rgba(255,255,255,0.9);border:1px solid rgba(0,0,0,0.2);color:#1e293b;padding:8px;">
            <button type="submit" class="btn">üöÄ Post Flyer</button>
          </form>
          <button class="btn" onclick="loadFlyers()" style="margin-top:15px;background:rgba(255,255,255,0.8);color:#374151;border:1px solid rgba(0,0,0,0.15);">‚Üê Cancel</button>
        </div>
      `;
      feed.classList.remove('fade-out');
      feed.classList.add('fade-in');
    }, 150);
  }
  
  function createFlyer(event) {
    event.preventDefault();
    const form = event.target;
    const title = form.querySelector('input[placeholder="Event Title"]').value;
    const org = form.querySelector('input[placeholder="Organization Name"]').value;
    const description = form.querySelector('textarea').value;
    const date = form.querySelector('input[type="date"]').value;
    const eventTime = form.querySelector('#eventTime').value;
    const imageFile = form.querySelector('#imageUpload').files[0];
    
    const newPost = {
      id: Date.now(),
      title: title,
      org: org,
      description: description,
      date: date,
      eventTime: eventTime,
      isUserCreated: true
    };
    
    if (imageFile) {
      const reader = new FileReader();
      reader.onload = function(e) {
        newPost.image = e.target.result;
        createdPosts.push(newPost);
        localStorage.setItem('createdPosts', JSON.stringify(createdPosts));
        alert('Flyer created successfully!');
        loadFlyers();
      };
      reader.readAsDataURL(imageFile);
    } else {
      createdPosts.push(newPost);
      localStorage.setItem('createdPosts', JSON.stringify(createdPosts));
      alert('Flyer created successfully!');
      loadFlyers();
    }
  }
  
  // Save/unsave functionality with backend integration
  async function toggleSave(flyerId, button) {
    const isSaved = button.textContent.includes('Saved');
    
    // Check if it's a user-created post
    const userPost = createdPosts.find(p => p.id === flyerId);
    const flyerData = userPost || {
      id: flyerId,
      title: flyerId === 1 ? 'Data Science Society' : flyerId === 2 ? 'Fencing Club' : 'Association of Computing Machinery',
      description: flyerId === 1 ? 'Explore data analytics, machine learning, and AI' : flyerId === 2 ? 'Learn the art of fencing' : 'Join ACM for coding workshops and hackathons',
      image: flyerId === 1 ? '../assets/image.png' : flyerId === 2 ? '../assets/image copy.png' : '../assets/image copy 2.png'
    };
    
    try {
      if (isSaved) {
        // Remove from saved
        await fetch(`http://localhost:8080/api/flyers/${flyerId}/save`, {
          method: 'DELETE',
          credentials: 'include'
        });
        savedFlyers = savedFlyers.filter(f => f.id !== flyerId);
        button.textContent = '‚ù§ Save';
        button.setAttribute('aria-pressed', 'false');
      } else {
        // Add to saved
        await fetch(`http://localhost:8080/api/flyers/${flyerId}/save`, {
          method: 'POST',
          credentials: 'include'
        });
        savedFlyers.push(flyerData);
        button.textContent = '‚úî Saved';
        button.setAttribute('aria-pressed', 'true');
      }
    } catch(error) {
      console.log('Backend offline, using localStorage only');
      if (isSaved) {
        savedFlyers = savedFlyers.filter(f => f.id !== flyerId);
        button.textContent = '‚ù§ Save';
        button.setAttribute('aria-pressed', 'false');
      } else {
        savedFlyers.push(flyerData);
        button.textContent = '‚úî Saved';
        button.setAttribute('aria-pressed', 'true');
      }
    }
    
    localStorage.setItem('savedFlyers', JSON.stringify(savedFlyers));
  }
  
  // Local storage for saved flyers and created posts
  let savedFlyers = JSON.parse(localStorage.getItem('savedFlyers') || '[]');
  let createdPosts = JSON.parse(localStorage.getItem('createdPosts') || '[]');
  let myEvents = JSON.parse(localStorage.getItem('myEvents') || '[]');
  
  // Load saved flyers from backend
  async function loadSavedFlyersFromBackend() {
    try {
      const response = await fetch('http://localhost:8080/api/flyers/saved', {
        credentials: 'include'
      });
      if (response.ok) {
        const backendFlyers = await response.json();
        // Merge with localStorage
        savedFlyers = [...savedFlyers, ...backendFlyers.filter(bf => !savedFlyers.some(sf => sf.id === bf.id))];
        localStorage.setItem('savedFlyers', JSON.stringify(savedFlyers));
      }
    } catch(error) {
      console.log('Backend offline, using localStorage only');
    }
  }
  
  // Load followed orgs from backend
  async function loadFollowedOrgsFromBackend() {
    try {
      const response = await fetch('http://localhost:8080/api/user/followedOrgs', {
        credentials: 'include'
      });
      if (response.ok) {
        const orgs = await response.json();
        followedOrgs = orgs.map(o => o.id);
        localStorage.setItem('followedOrgs', JSON.stringify(followedOrgs));
      }
    } catch(error) {
      console.log('Backend offline, using localStorage only');
    }
  }
  
  // Show favorites tab
  function showFavorites() {
    const feed = document.querySelector('.feed');
    feed.classList.add('fade-out');
    
    setTimeout(() => {
      let favoritesHTML = '<div style="margin-bottom:20px;"><h2 style="color:#e6eef8;font-weight:700;margin:0 0 10px 0;">‚ù§Ô∏è Favorites</h2><p style="color:var(--muted);margin:0;">Your saved flyers</p></div>';
      
      if (savedFlyers.length === 0) {
        favoritesHTML += `
          <div class="poster" style="background:linear-gradient(180deg,#ffffff,#f1f5f9);border:2px solid rgba(255,255,255,0.8);text-align:center;padding:40px;">
            <h3 style="color:#1e293b;margin-bottom:15px;">‚ù§Ô∏è No Saved Flyers</h3>
            <p style="color:#475569;margin:20px 0;">Start saving flyers you're interested in!</p>
            <button class="btn" onclick="loadFlyers()">Discover Flyers</button>
          </div>
        `;
      } else {
        savedFlyers.forEach((flyer, index) => {
          const org = organizations.find(o => o.name === flyer.title);
          const titleWithOrg = org ? `<h3 style="color:#1e293b;font-weight:700;margin:0 0 12px 0;cursor:pointer;display:flex;align-items:center;gap:8px;" onclick="showOrgProfile(${org.id})"><div style="width:28px;height:28px;border-radius:6px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-size:1rem;">${org.icon}</div><span>${flyer.title}</span></h3>` : `<h3 style="color:#1e293b;font-weight:700;margin:0 0 12px 0;">${flyer.title}</h3>`;
          favoritesHTML += `
            <article class="poster" style="background:linear-gradient(180deg,#fff4f2,#fff7f0);border:2px solid rgba(255,255,255,0.8);">
              <div class="meta">
                <div>
                  ${titleWithOrg}
                  <div class="small" style="color:#475569;">Saved Flyer</div>
                </div>
                <div class="small" style="color:#059669;">‚≠ê Saved</div>
              </div>
              ${flyer.image ? `<img src="${flyer.image}" alt="${flyer.title}">` : `<div class="poster-img" style="background:linear-gradient(135deg,#ffd6e0,#ffd7b5);">üéÜ ${flyer.title}</div>`}
              <div>
                <p style="color:#475569;margin:15px 0;">${flyer.description}</p>
                <div class="actions">
                  <button class="icon-btn" onclick="removeFavorite(${index})">‚ùå Remove</button>
                  <button class="btn" onclick="openDetails('${flyer.title}', this)">View Details</button>
                </div>
              </div>
            </article>
          `;
        });
      }
      
      feed.innerHTML = favoritesHTML;
      feed.classList.remove('fade-out');
      feed.classList.add('fade-in');
    }, 150);
  }
  
  // Remove from favorites
  function removeFavorite(index) {
    savedFlyers.splice(index, 1);
    localStorage.setItem('savedFlyers', JSON.stringify(savedFlyers));
    showFavorites(); // Refresh the view
  }
  
  // Show discussion tab
  function showDiscussion() {
    const feed = document.querySelector('.feed');
    feed.classList.add('fade-out');
    
    setTimeout(() => {
      feed.innerHTML = `
        <div style="margin-bottom:20px;"><h2 style="color:#e6eef8;font-weight:700;margin:0 0 10px 0;">üí¨ Discussion</h2><p style="color:var(--muted);margin:0;">Community discussion board</p></div>
        <div class="poster" style="background:linear-gradient(180deg,#ffffff,#f1f5f9);border:2px solid rgba(255,255,255,0.8);">
          <h3 style="color:#1e293b;font-weight:700;margin-bottom:15px;">Post a Message</h3>
          <form onsubmit="postMessage(event)" style="display:flex;flex-direction:column;gap:10px;">
            <textarea id="messageInput" placeholder="Share your thoughts..." required style="width:100%;min-height:100px;padding:12px;border-radius:10px;border:1px solid rgba(0,0,0,0.15);background:rgba(255,255,255,0.9);color:#1e293b;resize:vertical;font-family:inherit;"></textarea>
            <button type="submit" class="btn" style="align-self:flex-start;">Post Message</button>
          </form>
        </div>
        <div id="messageList"></div>
      `;
      
      feed.classList.remove('fade-out');
      feed.classList.add('fade-in');
      
      loadMessages();
    }, 150);
  }
  
  // Add event to my events
  function addToEvents(eventName, eventTime) {
    const eventExists = myEvents.find(e => e.name === eventName);
    if (eventExists) {
      alert('Event already added!');
      return;
    }
    
    myEvents.push({
      id: Date.now(),
      name: eventName,
      time: eventTime,
      addedDate: new Date().toLocaleDateString()
    });
    
    localStorage.setItem('myEvents', JSON.stringify(myEvents));
    alert('Event added to your calendar!');
  }
  
  // Show events tab
  function showEvents() {
    const feed = document.querySelector('.feed');
    feed.classList.add('fade-out');
    
    setTimeout(() => {
      let eventsHTML = '<div style="margin-bottom:20px;"><h2 style="color:#e6eef8;font-weight:700;margin:0 0 10px 0;">üìÖ Events</h2><p style="color:var(--muted);margin:0;">Your saved events</p></div>';
      
      if (myEvents.length === 0) {
        eventsHTML += `
          <div class="poster" style="background:linear-gradient(180deg,#ffffff,#f1f5f9);border:2px solid rgba(255,255,255,0.8);text-align:center;padding:40px;">
            <h3 style="color:#1e293b;margin-bottom:15px;">üìÖ No Events Yet</h3>
            <p style="color:#475569;margin:20px 0;">No events added yet. Add events from the Discover tab!</p>
          </div>
        `;
      } else {
        myEvents.forEach((event, index) => {
          eventsHTML += `
            <article class="poster" style="background:linear-gradient(180deg,#ffffff,#f1f5f9);border:2px solid rgba(255,255,255,0.8);">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                <h3 style="color:#1e293b;font-weight:700;margin:0;">${event.name}</h3>
                <button class="icon-btn" onclick="removeEvent(${index})" style="background:rgba(239,68,68,0.1);border-color:rgba(239,68,68,0.3);color:#dc2626;">‚ùå</button>
              </div>
              <div style="color:#475569;font-weight:500;margin-bottom:8px;">
                <div style="margin-bottom:6px;">üïê ${event.time}</div>
                <div style="font-size:0.85rem;color:#64748b;">Added: ${event.addedDate}</div>
              </div>
            </article>
          `;
        });
      }
      
      feed.innerHTML = eventsHTML;
      feed.classList.remove('fade-out');
      feed.classList.add('fade-in');
    }, 150);
  }
  
  // Remove event
  function removeEvent(index) {
    myEvents.splice(index, 1);
    localStorage.setItem('myEvents', JSON.stringify(myEvents));
    showEvents();
  }
  

  
  // Share flyer
  function shareFlyer(clubName) {
    const shareUrl = `${window.location.origin}${window.location.pathname}?club=${encodeURIComponent(clubName)}`;
    navigator.clipboard.writeText(shareUrl).then(() => {
      alert(`Link copied to clipboard! Share this link: ${shareUrl}`);
    }).catch(() => {
      alert(`Share this link: ${shareUrl}`);
    });
  }
  
  // Render club card function
  function renderClubCard(org) {
    const gradients = {
      1: 'linear-gradient(180deg,#ffffff,#f1f5f9)',
      2: 'linear-gradient(180deg,#fff4f2,#fff7f0)',
      3: 'linear-gradient(180deg,#fffef2,#f5fff1)',
      4: 'linear-gradient(180deg,#f0f9ff,#e0f2fe)',
      5: 'linear-gradient(180deg,#fef2f2,#fff1f2)',
      6: 'linear-gradient(180deg,#f3e8ff,#faf5ff)'
    };
    const ratings = {1: '4.9', 2: '4.7', 3: '5.0', 4: '4.8', 5: '4.9', 6: '4.8'};
    const meetingDay = org.eventTime.split(' ')[0];
    
    return `
      <article class="poster" role="article" style="background:${gradients[org.id] || 'linear-gradient(180deg,#ffffff,#f1f5f9)'};">
        <div class="meta">
          <div>
            <h3 style="margin:0 0 12px 0;cursor:pointer;display:flex;align-items:center;gap:8px;" onclick="showOrgProfile(${org.id})">
              <div style="width:28px;height:28px;border-radius:6px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-size:1rem;">${org.icon}</div>
              <span>${org.name}</span>
            </h3>
            <div class="small">${org.category} ‚Ä¢ ${meetingDay}</div>
          </div>
          <div class="small">${ratings[org.id] || '4.8'} ‚òÖ</div>
        </div>
        <img src="${org.image}" alt="${org.name} poster">
        <div>
          <p>${org.description}${org.id === 4 ? '. Learn Unity, Unreal Engine, and game design principles.' : org.id === 1 ? '. All skill levels welcome.' : org.id === 2 ? '. Equipment provided for beginners. Join our competitive team.' : '. Network with industry professionals.'}</p>
          <div class="actions">
            <div>
              <button class="icon-btn" onclick="toggleSave(${org.id}, this)">‚ù§ Save</button>
              <button class="icon-btn" onclick="addToEvents('${org.name}', '${org.eventTime}')">üìÖ Add Event</button>
              <button class="icon-btn" onclick="shareFlyer('${org.name}')">üîó Share</button>
            </div>
            <button class="btn" onclick="openDetails('${org.name}', this)">View</button>
          </div>
        </div>
      </article>
    `;
  }
  
  // Organizations data
  const organizations = [
    {id: 1, name: 'Data Science Society', category: 'Technology', members: 200, description: 'Explore data analytics, machine learning, and AI', icon: 'üìä', eventTime: 'Tuesdays 5:30 PM', image: '../assets/image.png', fullDescription: 'The Data Science Society is dedicated to fostering a community of data enthusiasts. We organize weekly workshops covering Python, R, SQL, and machine learning frameworks. Members work on real-world datasets, participate in Kaggle competitions, and collaborate on research projects. Our alumni have gone on to work at top tech companies and research institutions.', founded: '2018', location: 'Woodward Hall 335', contact: 'datasci@charlotte.edu'},
    {id: 2, name: 'Fencing Club', category: 'Sports', members: 75, description: 'Learn the art of fencing', icon: 'ü§∫', eventTime: 'Mondays & Thursdays 6:00 PM', image: '../assets/image copy.png', fullDescription: 'Our Fencing Club welcomes all skill levels from complete beginners to competitive athletes. We provide all equipment for newcomers and offer instruction in foil, √©p√©e, and sabre. Our certified coaches have national and international competition experience. We compete in regional tournaments and host an annual invitational. Join us to develop discipline, strategy, and athleticism.', founded: '2015', location: 'Recreation Center Gym 2', contact: 'fencing@charlotte.edu'},
    {id: 3, name: 'Association of Computing Machinery', category: 'Technology', members: 350, description: 'Join ACM for coding workshops and hackathons', icon: 'üíª', eventTime: 'Wednesdays 7:00 PM', image: '../assets/image copy 2.png', fullDescription: 'ACM is the largest computing organization on campus. We host weekly tech talks featuring industry professionals, organize hackathons with prizes up to $10,000, and maintain several open-source projects. Our members have access to exclusive internship opportunities, interview prep sessions, and networking events with recruiters from Fortune 500 companies. Special interest groups focus on AI, cybersecurity, web development, and game design.', founded: '2010', location: 'Student Union 340', contact: 'acm@charlotte.edu'},
    {id: 4, name: 'Niner Game Development', category: 'Technology', members: 180, description: 'Create games and interactive experiences', icon: 'üéÆ', eventTime: 'Wednesdays 6:00 PM', image: '../assets/image copy 3.png', fullDescription: 'Niner Game Development brings together aspiring game developers, artists, and designers. We organize weekly game jams, Unity and Unreal Engine workshops, and collaborative project teams. Members learn game design principles, programming patterns, 3D modeling, and animation. We participate in Global Game Jam and showcase student projects at annual exhibitions. Whether you want to build indie games or work for major studios, we provide the skills and community to help you succeed.', founded: '2019', location: 'College of Computing and Informatics Room 223', contact: 'gamedev@charlotte.edu'},
    {id: 5, name: 'The Guild', category: 'Recreation', members: 95, description: 'Relax with board games and snacks', icon: 'üé≤', eventTime: 'Fridays 3:00 PM - 6:00 PM', image: '../assets/image copy 4.png', fullDescription: 'The Guild is your friendly neighborhood board game club where students gather to unwind, strategize, and have fun. We play everything from classic favorites like Settlers of Catan and Ticket to Ride to modern strategy games and party games. No experience needed - we teach new players and welcome all skill levels. Snacks and drinks provided every session. Come make friends, learn new games, and escape the stress of classes for a few hours each week.', founded: '2020', location: 'CHHS 128', contact: 'theguild@charlotte.edu'},
    {id: 6, name: 'Niner Notes', category: 'Music', members: 65, description: 'Produce your own tracks', icon: 'üéµ', eventTime: 'Thursdays 6:00 PM', image: '../assets/image copy 6.png', fullDescription: 'Niner Notes is the premier music production club on campus where aspiring producers, beatmakers, and audio engineers come together to create original music. Our weekly sessions cover everything from basic DAW operation to advanced mixing and mastering techniques. Members have access to professional-grade equipment and software, collaborate on original compositions, and learn from guest producers and industry professionals. Whether you\'re into hip-hop, electronic, rock, or any other genre, join us to turn your musical ideas into reality.', founded: '2021', location: 'Atkins G35', contact: 'ninernotes@charlotte.edu'}
  ];
  
  let followedOrgs = JSON.parse(localStorage.getItem('followedOrgs') || '[]');
  
  // Show Organizations tab
  function showOrganizations() {
    const feed = document.querySelector('.feed');
    feed.classList.add('fade-out');
    
    setTimeout(() => {
      let orgsHTML = '<div style="margin-bottom:20px;"><h2 style="color:#e6eef8;font-weight:700;margin:0 0 10px 0;">üèõÔ∏è Organizations</h2><p style="color:var(--muted);margin:0;">Discover and follow organizations</p></div>';
      
      organizations.forEach(org => {
        const isFollowing = followedOrgs.includes(org.id);
        orgsHTML += `
          <article class="poster" style="background:linear-gradient(180deg,#ffffff,#f1f5f9);border:2px solid rgba(255,255,255,0.8);cursor:pointer;" onclick="showOrgProfile(${org.id})">
            <div style="display:flex;align-items:center;gap:15px;margin-bottom:15px;">
              <div style="width:60px;height:60px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-size:2rem;flex-shrink:0;">${org.icon}</div>
              <div style="flex:1;">
                <h3 style="color:#1e293b;font-weight:700;margin:0 0 5px 0;">${org.name}</h3>
                <div style="color:#64748b;font-size:0.9rem;">${org.category} ‚Ä¢ ${org.members} members</div>
              </div>
              <button class="btn" onclick="event.stopPropagation(); toggleFollow(${org.id})" style="${isFollowing ? 'background:rgba(255,255,255,0.8);color:#374151;border:1px solid rgba(0,0,0,0.15);' : ''}">${isFollowing ? 'Following' : 'Follow'}</button>
            </div>
            <p style="color:#475569;font-weight:500;margin:0;">${org.description}</p>
          </article>
        `;
      });
      
      feed.innerHTML = orgsHTML;
      feed.classList.remove('fade-out');
      feed.classList.add('fade-in');
    }, 150);
  }
  
  // Toggle follow organization
  async function toggleFollow(orgId, skipRefresh) {
    const index = followedOrgs.indexOf(orgId);
    const isFollowing = index > -1;
    
    try {
      if (isFollowing) {
        await fetch(`http://localhost:8080/api/orgs/${orgId}/follow`, {
          method: 'DELETE',
          credentials: 'include'
        });
        followedOrgs.splice(index, 1);
      } else {
        await fetch(`http://localhost:8080/api/orgs/${orgId}/follow`, {
          method: 'POST',
          credentials: 'include'
        });
        followedOrgs.push(orgId);
      }
      localStorage.setItem('followedOrgs', JSON.stringify(followedOrgs));
      if (!skipRefresh) showOrganizations();
    } catch(error) {
      console.error('Backend offline, using localStorage only');
      if (isFollowing) {
        followedOrgs.splice(index, 1);
      } else {
        followedOrgs.push(orgId);
      }
      localStorage.setItem('followedOrgs', JSON.stringify(followedOrgs));
      if (!skipRefresh) showOrganizations();
    }
  }
  
  // Show organization profile
  function showOrgProfile(orgId) {
    const org = organizations.find(o => o.id === orgId);
    if (!org) return;
    
    const feed = document.querySelector('.feed');
    feed.classList.add('fade-out');
    
    setTimeout(() => {
      const isFollowing = followedOrgs.includes(org.id);
      const orgPosts = createdPosts.filter(p => p.org === org.name);
      
      let postsHTML = '';
      if (orgPosts.length > 0) {
        orgPosts.forEach(post => {
          const imageHTML = post.image ? `<img src="${post.image}" alt="${post.title}">` : `<div class="poster-img" style="background:linear-gradient(135deg,#bfdbfe,#ddd6fe);">üéâ ${post.title}</div>`;
          postsHTML += `
            <article class="poster" style="background:linear-gradient(180deg,#e0f2fe,#f0f9ff);border:2px solid rgba(255,255,255,0.8);">
              <div class="meta">
                <div>
                  <h3 style="color:#1e293b;font-weight:700;">${post.title}</h3>
                  <div class="small" style="color:#475569;">${post.date}</div>
                </div>
              </div>
              ${imageHTML}
              <div>
                <p style="color:#475569;margin:15px 0;">${post.description}</p>
              </div>
            </article>
          `;
        });
      } else {
        postsHTML = '<p style="color:var(--muted);text-align:center;padding:40px 0;">No posts yet from this organization</p>';
      }
      
      feed.innerHTML = `
        <div class="poster" style="background:var(--surface);border:2px solid rgba(255,255,255,0.8);padding:24px;">
          <div style="display:flex;flex-direction:column;align-items:center;text-align:center;">
            <div style="width:110px;height:110px;border-radius:16px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-size:2.6rem;font-weight:bold;color:#022047;margin-bottom:14px;">${org.icon}</div>
            <h2 style="color:#f8fafc;font-weight:700;font-size:1.6rem;margin:0 0 6px 0;">${org.name}</h2>
            <div style="color:var(--muted);font-size:0.95rem;margin-bottom:10px;">${org.category} ‚Ä¢ ${org.members} members</div>
            <p style="color:var(--muted);font-size:0.95rem;line-height:1.4;margin-bottom:16px;">${org.description}</p>
            <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:center;">
              <button class="btn" onclick="toggleFollow(${org.id}, true); showOrgProfile(${org.id});" style="${isFollowing ? 'background:rgba(255,255,255,0.8);color:#374151;border:1px solid rgba(0,0,0,0.15);' : ''}">${isFollowing ? 'Following' : 'Follow'}</button>
              ${org.eventTime ? `<button class="btn" onclick="addToEvents('${org.name}', '${org.eventTime}')" style="background:rgba(255,255,255,0.8);color:#374151;border:1px solid rgba(0,0,0,0.15);">üìÖ Add Event</button>` : ''}
              <button class="btn" onclick="showOrgLearnMore(${org.id})" style="background:rgba(255,255,255,0.8);color:#374151;border:1px solid rgba(0,0,0,0.15);">üìñ Learn More</button>
              <button class="btn" onclick="showOrganizations()" style="background:rgba(255,255,255,0.8);color:#374151;border:1px solid rgba(0,0,0,0.15);">‚Üê Back</button>
            </div>
          </div>
        </div>
        <div style="margin:20px 0;"><h3 style="color:#e6eef8;font-weight:700;">Recent Posts</h3></div>
        ${postsHTML}
      `;
      
      feed.classList.remove('fade-out');
      feed.classList.add('fade-in');
    }, 150);
  }
  
  // Show Personal Feed with backend integration
  async function showPersonalFeed() {
    const feed = document.querySelector('.feed');
    feed.classList.add('fade-out');
    
    setTimeout(async () => {
      try {
        const response = await fetch('http://localhost:8080/api/favorites', {
          credentials: 'include'
        });
        
        if (response.ok) {
          const backendFlyers = await response.json();
          
          let feedHTML = '<div style="margin-bottom:20px;"><h2 style="color:#e6eef8;font-weight:700;margin:0 0 10px 0;">üì∞ Personal Feed</h2><p style="color:var(--muted);margin:0;">Posts from organizations you follow</p></div>';
          
          if (backendFlyers.length === 0 && followedOrgs.length === 0) {
            feedHTML = `
              <div class="poster" style="background:linear-gradient(180deg,#ffffff,#f1f5f9);border:2px solid rgba(255,255,255,0.8);text-align:center;padding:40px;">
                <h3 style="color:#1e293b;margin-bottom:15px;">üì∞ Personal Feed</h3>
                <p style="color:#475569;margin:20px 0;">Follow organizations to see their posts in your personal feed!</p>
                <button class="btn" onclick="showOrganizations()">Browse Organizations</button>
              </div>
            `;
          } else if (backendFlyers.length > 0) {
            backendFlyers.forEach(flyer => {
              const org = organizations.find(o => o.id === flyer.orgId);
              feedHTML += `
                <article class="poster" style="background:linear-gradient(180deg,#ffffff,#f1f5f9);border:2px solid rgba(255,255,255,0.8);">
                  <div class="meta">
                    <div>
                      ${org ? `<div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;cursor:pointer;" onclick="showOrgProfile(${org.id})"><div style="width:32px;height:32px;border-radius:8px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-size:1.2rem;">${org.icon}</div><span style="color:#1e293b;font-weight:600;">${org.name}</span></div>` : ''}
                      <h3 style="color:#1e293b;font-weight:700;margin:0 0 12px 0;">${flyer.flyerAdvert}</h3>
                    </div>
                  </div>
                  <div>
                    <div class="actions">
                      <div>
                        <button class="icon-btn" onclick="toggleSave(${flyer.id}, this)">‚ù§ Save</button>
                        <button class="icon-btn" onclick="shareFlyer('${org?.name || 'Event'}')">üîó Share</button>
                      </div>
                      <button class="btn" onclick="openDetails('${org?.name || 'Event'}', this)">View</button>
                    </div>
                  </div>
                </article>
              `;
            });
          } else {
            feedHTML += '<p style="color:var(--muted);text-align:center;padding:40px 0;">No posts yet from followed organizations</p>';
          }
          
          feed.innerHTML = feedHTML;
          feed.classList.remove('fade-out');
          feed.classList.add('fade-in');
          return;
        }
      } catch(error) {
        console.log('Backend offline, using localStorage');
      }
      
      // Fallback to localStorage
      if (followedOrgs.length === 0) {
        feed.innerHTML = `
          <div class="poster" style="background:linear-gradient(180deg,#ffffff,#f1f5f9);border:2px solid rgba(255,255,255,0.8);text-align:center;padding:40px;">
            <h3 style="color:#1e293b;margin-bottom:15px;">üì∞ Personal Feed</h3>
            <p style="color:#475569;margin:20px 0;">Follow organizations to see their posts in your personal feed!</p>
            <button class="btn" onclick="showOrganizations()">Browse Organizations</button>
          </div>
        `;
      } else {
        const followedOrgNames = organizations.filter(o => followedOrgs.includes(o.id)).map(o => o.name);
        const feedPosts = createdPosts.filter(p => followedOrgNames.includes(p.org));
        
        let feedHTML = '<div style="margin-bottom:20px;"><h2 style="color:#e6eef8;font-weight:700;margin:0 0 10px 0;">üì∞ Personal Feed</h2><p style="color:var(--muted);margin:0;">Posts from organizations you follow</p></div>';
        
        if (feedPosts.length === 0) {
          feedHTML += '<p style="color:var(--muted);text-align:center;padding:40px 0;">No posts yet from followed organizations</p>';
        } else {
          feedPosts.forEach(post => {
            const org = organizations.find(o => o.name === post.org);
            const imageHTML = post.image ? `<img src="${post.image}" alt="${post.title}">` : `<div class="poster-img" style="background:linear-gradient(135deg,#bfdbfe,#ddd6fe);">üéâ ${post.title}</div>`;
            feedHTML += `
              <article class="poster" style="background:linear-gradient(180deg,#ffffff,#f1f5f9);border:2px solid rgba(255,255,255,0.8);">
                <div class="meta">
                  <div>
                    <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;cursor:pointer;" onclick="showOrgProfile(${org?.id})">
                      <div style="width:32px;height:32px;border-radius:8px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-size:1.2rem;">${org?.icon || 'üèõÔ∏è'}</div>
                      <span style="color:#1e293b;font-weight:600;">${post.org}</span>
                    </div>
                    <h3 style="color:#1e293b;font-weight:700;margin:0 0 5px 0;">${post.title}</h3>
                    <div class="small" style="color:#475569;">${post.date}</div>
                  </div>
                </div>
                ${imageHTML}
                <div>
                  <p style="color:#475569;margin:15px 0;">${post.description}</p>
                  <div class="actions">
                    <div>
                      <button class="icon-btn" onclick="toggleSave(${post.id}, this)">‚ù§ Save</button>
                      ${post.eventTime ? `<button class="icon-btn" onclick="addToEvents('${post.title}', '${post.eventTime}')">üìÖ Add Event</button>` : ''}
                      <button class="icon-btn" onclick="shareFlyer('${post.title}')">üîó Share</button>
                    </div>
                    <button class="btn" onclick="openDetails('${post.title}', this)">View</button>
                  </div>
                </div>
              </article>
            `;
          });
        }
        
        feed.innerHTML = feedHTML;
      }
      
      feed.classList.remove('fade-out');
      feed.classList.add('fade-in');
    }, 150);
  }
  
  // Post message function
  function postMessage(event) {
    event.preventDefault();
    const input = document.getElementById('messageInput');
    const message = input.value.trim();
    if (!message) return;
    
    // Get existing messages
    let messages = JSON.parse(localStorage.getItem('discussionMessages') || '[]');
    
    // Add new message
    messages.unshift({
      id: Date.now(),
      text: message,
      timestamp: new Date().toLocaleString(),
      author: 'You'
    });
    
    // Save to localStorage
    localStorage.setItem('discussionMessages', JSON.stringify(messages));
    
    // Clear input
    input.value = '';
    
    // Reload messages
    loadMessages();
  }
  
  // Load messages function
  function loadMessages() {
    const messageList = document.getElementById('messageList');
    const messages = JSON.parse(localStorage.getItem('discussionMessages') || '[]');
    
    if (messages.length === 0) {
      messageList.innerHTML = '<p style="color:#475569;text-align:center;margin:20px 0;">No messages yet. Be the first to start a discussion!</p>';
      return;
    }
    
    messageList.innerHTML = messages.map(msg => `
      <div class="poster discussion-post" style="background:linear-gradient(180deg,#ffffff,#f1f5f9);border:2px solid rgba(255,255,255,0.8);padding:16px;transition:transform 0.3s ease, box-shadow 0.3s ease;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
          <div style="font-weight:700;color:#1e293b;font-size:1rem;">${msg.author}</div>
          <div style="font-size:0.8rem;color:#64748b;">${msg.timestamp}</div>
        </div>
        <div style="color:#475569;font-weight:500;">${msg.text}</div>
      </div>
    `).join('');
  }
  
  // Post comment with backend integration
  async function postComment(event, eventName) {
    event.preventDefault();
    const form = event.target;
    const textarea = form.querySelector('textarea');
    const comment = textarea.value.trim();
    if (!comment) return;
    
    // Find flyer ID based on event name
    const org = organizations.find(o => o.name === eventName);
    const flyerId = org?.id || Date.now();
    
    try {
      const response = await fetch(`http://localhost:8080/api/flyers/${flyerId}/comments`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        credentials: 'include',
        body: JSON.stringify({
          userId: 1, // Would come from session
          content: comment
        })
      });
      
      if (response.ok) {
        textarea.value = '';
        loadComments(eventName, flyerId);
        return;
      }
    } catch(error) {
      console.log('Backend offline, using localStorage');
    }
    
    // Fallback to localStorage
    let comments = JSON.parse(localStorage.getItem(`comments_${eventName}`) || '[]');
    comments.unshift({
      id: Date.now(),
      text: comment,
      author: 'You',
      timestamp: new Date().toLocaleString()
    });
    localStorage.setItem(`comments_${eventName}`, JSON.stringify(comments));
    
    textarea.value = '';
    loadComments(eventName, flyerId);
  }
  
  // Load comments with backend integration
  async function loadComments(eventName, flyerId) {
    const commentsSection = document.getElementById('commentsSection');
    
    try {
      const response = await fetch(`http://localhost:8080/api/flyers/${flyerId}/comments`, {
        credentials: 'include'
      });
      
      if (response.ok) {
        const backendComments = await response.json();
        if (backendComments.length > 0) {
          commentsSection.innerHTML = backendComments.map(comment => `
            <div style="background:rgba(248,250,252,0.8);padding:15px;border-radius:10px;margin-bottom:10px;border:1px solid rgba(226,232,240,0.8);">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                <span style="font-weight:600;color:#1e293b;">User ${comment.userId}</span>
                <span style="font-size:0.85rem;color:#64748b;">${new Date(comment.createdAt).toLocaleString()}</span>
              </div>
              <p style="color:#374151;margin:0;">${comment.content}</p>
            </div>
          `).join('');
          return;
        }
      }
    } catch(error) {
      console.log('Backend offline, using localStorage');
    }
    
    // Fallback to localStorage
    const comments = JSON.parse(localStorage.getItem(`comments_${eventName}`) || '[]');
    
    if (comments.length === 0) {
      commentsSection.innerHTML = '<p style="color:#64748b;text-align:center;padding:20px 0;">No comments yet. Be the first to comment!</p>';
      return;
    }
    
    commentsSection.innerHTML = comments.map(comment => `
      <div style="background:rgba(248,250,252,0.8);padding:15px;border-radius:10px;margin-bottom:10px;border:1px solid rgba(226,232,240,0.8);">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
          <span style="font-weight:600;color:#1e293b;">${comment.author}</span>
          <span style="font-size:0.85rem;color:#64748b;">${comment.timestamp}</span>
        </div>
        <p style="color:#374151;margin:0;">${comment.text}</p>
      </div>
    `).join('');
  }
  
  // Show Popular flyers
  async function showPopular() {
    const feed = document.querySelector('.feed');
    feed.classList.add('fade-out');
    
    setTimeout(async () => {
      try {
        const response = await fetch('http://localhost:8080/api/flyers/popular', {
          credentials: 'include'
        });
        
        if (response.ok) {
          const flyers = await response.json();
          let flyersHTML = '<div style="margin-bottom:20px;"><h2 style="color:#e6eef8;font-weight:700;margin:0 0 10px 0;">üî• Popular</h2><p style="color:var(--muted);margin:0;">Most popular flyers right now</p></div>';
          
          if (flyers.length === 0) {
            flyersHTML += '<p style="color:var(--muted);text-align:center;padding:40px 0;">No popular flyers yet</p>';
          } else {
            flyers.forEach(flyer => {
              const org = organizations.find(o => o.id === flyer.orgId);
              flyersHTML += `
                <article class="poster" style="background:linear-gradient(180deg,#ffffff,#f1f5f9);border:2px solid rgba(255,255,255,0.8);">
                  <div class="meta">
                    <div>
                      ${org ? `<h3 style="margin:0 0 12px 0;cursor:pointer;display:flex;align-items:center;gap:8px;" onclick="showOrgProfile(${org.id})"><div style="width:28px;height:28px;border-radius:6px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-size:1rem;">${org.icon}</div><span>${org.name}</span></h3>` : ''}
                      <div class="small" style="color:#475569;">üî• Popularity: ${flyer.popularityScore}</div>
                    </div>
                  </div>
                  <div>
                    <p style="color:#475569;margin:15px 0;">${flyer.flyerAdvert}</p>
                    <div class="actions">
                      <div>
                        <button class="icon-btn" onclick="toggleSave(${flyer.id}, this)">‚ù§ Save</button>
                        <button class="icon-btn" onclick="shareFlyer('${org?.name || 'Event'}')">üîó Share</button>
                      </div>
                      <button class="btn" onclick="openDetails('${org?.name || 'Event'}', this)">View</button>
                    </div>
                  </div>
                </article>
              `;
            });
          }
          
          feed.innerHTML = flyersHTML;
        } else {
          feed.innerHTML = '<p style="color:var(--muted);text-align:center;padding:40px 0;">Unable to load popular flyers</p>';
        }
      } catch(error) {
        feed.innerHTML = '<p style="color:var(--muted);text-align:center;padding:40px 0;">Backend offline. Popular flyers unavailable.</p>';
      }
      
      feed.classList.remove('fade-out');
      feed.classList.add('fade-in');
    }, 150);
  }
  
  // Show Trending flyers
  async function showTrending() {
    const feed = document.querySelector('.feed');
    feed.classList.add('fade-out');
    
    setTimeout(async () => {
      try {
        const response = await fetch('http://localhost:8080/api/flyers/trending', {
          credentials: 'include'
        });
        
        if (response.ok) {
          const flyers = await response.json();
          let flyersHTML = '<div style="margin-bottom:20px;"><h2 style="color:#e6eef8;font-weight:700;margin:0 0 10px 0;">üìà Trending</h2><p style="color:var(--muted);margin:0;">Trending flyers this week</p></div>';
          
          if (flyers.length === 0) {
            flyersHTML += '<p style="color:var(--muted);text-align:center;padding:40px 0;">No trending flyers yet</p>';
          } else {
            flyers.forEach(flyer => {
              const org = organizations.find(o => o.id === flyer.orgId);
              flyersHTML += `
                <article class="poster" style="background:linear-gradient(180deg,#ffffff,#f1f5f9);border:2px solid rgba(255,255,255,0.8);">
                  <div class="meta">
                    <div>
                      ${org ? `<h3 style="margin:0 0 12px 0;cursor:pointer;display:flex;align-items:center;gap:8px;" onclick="showOrgProfile(${org.id})"><div style="width:28px;height:28px;border-radius:6px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-size:1rem;">${org.icon}</div><span>${org.name}</span></h3>` : ''}
                      <div class="small" style="color:#475569;">üìà Trending</div>
                    </div>
                  </div>
                  <div>
                    <p style="color:#475569;margin:15px 0;">${flyer.flyerAdvert}</p>
                    <div class="actions">
                      <div>
                        <button class="icon-btn" onclick="toggleSave(${flyer.id}, this)">‚ù§ Save</button>
                        <button class="icon-btn" onclick="shareFlyer('${org?.name || 'Event'}')">üîó Share</button>
                      </div>
                      <button class="btn" onclick="openDetails('${org?.name || 'Event'}', this)">View</button>
                    </div>
                  </div>
                </article>
              `;
            });
          }
          
          feed.innerHTML = flyersHTML;
        } else {
          feed.innerHTML = '<p style="color:var(--muted);text-align:center;padding:40px 0;">Unable to load trending flyers</p>';
        }
      } catch(error) {
        feed.innerHTML = '<p style="color:var(--muted);text-align:center;padding:40px 0;">Backend offline. Trending flyers unavailable.</p>';
      }
      
      feed.classList.remove('fade-out');
      feed.classList.add('fade-in');
    }, 150);
  }
  
  // Show organization learn more popup
  function showOrgLearnMore(orgId) {
    const org = organizations.find(o => o.id === orgId);
    if (!org) return;
    
    const overlay = document.createElement('div');
    overlay.className = 'card-overlay';
    overlay.onclick = closeDetails;
    
    const expandedCard = document.createElement('div');
    expandedCard.className = 'expanded-card';
    expandedCard.innerHTML = `
      <button class="close-btn" id="closeBtn">√ó</button>
      <div style="margin-bottom: 25px;text-align:center;">
        <div style="width:80px;height:80px;border-radius:16px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-size:2.5rem;font-weight:bold;color:#022047;margin:0 auto 15px;">${org.icon}</div>
        <h2 style="color:#0f172a;font-weight:800;font-size:1.8rem;margin-bottom:8px;">${org.name}</h2>
        <div style="color:#64748b;font-weight:600;font-size:1rem;">${org.category} ‚Ä¢ ${org.members} members</div>
      </div>
      
      <div style="margin:25px 0;">
        <h4 style="color:#0f172a;font-weight:700;font-size:1.2rem;margin-bottom:15px;">About</h4>
        <p style="color:#374151;line-height:1.7;font-size:1rem;font-weight:500;">${org.fullDescription}</p>
      </div>
      
      <div style="margin:25px 0;background:rgba(248,250,252,0.8);padding:20px;border-radius:12px;border:1px solid rgba(226,232,240,0.8);">
        <h4 style="color:#0f172a;font-weight:700;font-size:1.2rem;margin-bottom:15px;">Details</h4>
        <div style="color:#374151;font-weight:500;">
          <p style="margin:8px 0;font-size:1rem;"><strong style="color:#1e293b;">Founded:</strong> ${org.founded}</p>
          <p style="margin:8px 0;font-size:1rem;"><strong style="color:#1e293b;">Meetings:</strong> ${org.eventTime}</p>
          <p style="margin:8px 0;font-size:1rem;"><strong style="color:#1e293b;">Location:</strong> ${org.location}</p>
          <p style="margin:8px 0;font-size:1rem;"><strong style="color:#1e293b;">Contact:</strong> ${org.contact}</p>
        </div>
      </div>
      
      <div style="display:flex;gap:12px;margin-top:35px;">
        <button class="btn" style="flex:1;font-weight:600;" onclick="toggleFollow(${org.id}, true); closeDetails(); showOrgProfile(${org.id});">${followedOrgs.includes(org.id) ? 'Unfollow' : 'Follow'}</button>
        <button class="icon-btn" style="font-weight:600;" onclick="addToEvents('${org.name}', '${org.eventTime}'); closeDetails();">üìÖ Add Event</button>
      </div>
    `;
    
    document.body.appendChild(overlay);
    document.body.appendChild(expandedCard);
    
    const closeBtn = expandedCard.querySelector('#closeBtn');
    closeBtn.addEventListener('click', closeDetails);
    
    setTimeout(() => {
      overlay.classList.add('show');
      expandedCard.classList.add('show');
    }, 10);
  }
  
  // Show Feeds tab with sub-navigation
  function showFeeds() {
    const feed = document.querySelector('.feed');
    feed.classList.add('fade-out');
    
    setTimeout(() => {
      feed.innerHTML = `
        <div style="margin-bottom:20px;">
          <h2 style="color:#e6eef8;font-weight:700;margin:0 0 10px 0;">üì∞ Feeds</h2>
          <p style="color:var(--muted);margin:0 0 15px 0;">View different feed types</p>
          <div style="display:flex;gap:10px;flex-wrap:wrap;">
            <button class="btn" onclick="loadFeedType('personal')">Personal</button>
            <button class="btn" onclick="loadFeedType('popular')" style="background:rgba(255,255,255,0.8);color:#374151;border:1px solid rgba(0,0,0,0.15);">Popular</button>
            <button class="btn" onclick="loadFeedType('trending')" style="background:rgba(255,255,255,0.8);color:#374151;border:1px solid rgba(0,0,0,0.15);">Trending</button>
          </div>
        </div>
        <div id="feedContent"></div>
      `;
      
      feed.classList.remove('fade-out');
      feed.classList.add('fade-in');
      
      // Auto-load personal feed
      setTimeout(() => loadFeedType('personal'), 50);
    }, 150);
  }
  
  // Load specific feed type
  async function loadFeedType(type) {
    const feedContent = document.getElementById('feedContent');
    if (!feedContent) return;
    
    if (type === 'personal') {
      await loadPersonalFeedContent(feedContent);
    } else if (type === 'popular') {
      await loadPopularContent(feedContent);
    } else if (type === 'trending') {
      await loadTrendingContent(feedContent);
    }
  }
  
  async function loadPersonalFeedContent(container) {
    try {
      const response = await fetch('http://localhost:8080/api/favorites', { credentials: 'include' });
      if (response.ok) {
        const backendFlyers = await response.json();
        if (backendFlyers.length === 0 && followedOrgs.length === 0) {
          container.innerHTML = '<p style="color:var(--muted);text-align:center;padding:40px 0;">Follow organizations to see their posts!</p>';
        } else if (backendFlyers.length > 0) {
          container.innerHTML = backendFlyers.map(flyer => {
            const org = organizations.find(o => o.id === flyer.orgId);
            return `<article class="poster" style="background:linear-gradient(180deg,#ffffff,#f1f5f9);border:2px solid rgba(255,255,255,0.8);"><div class="meta"><div>${org ? `<div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;cursor:pointer;" onclick="showOrgProfile(${org.id})"><div style="width:32px;height:32px;border-radius:8px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-size:1.2rem;">${org.icon}</div><span style="color:#1e293b;font-weight:600;">${org.name}</span></div>` : ''}<h3 style="color:#1e293b;font-weight:700;margin:0 0 12px 0;">${flyer.flyerAdvert}</h3></div></div><div><div class="actions"><div><button class="icon-btn" onclick="toggleSave(${flyer.id}, this)">‚ù§ Save</button><button class="icon-btn" onclick="shareFlyer('${org?.name || 'Event'}'">üîó Share</button></div><button class="btn" onclick="openDetails('${org?.name || 'Event'}', this)">View</button></div></div></article>`;
          }).join('');
        } else {
          container.innerHTML = '<p style="color:var(--muted);text-align:center;padding:40px 0;">No posts yet from followed organizations</p>';
        }
        return;
      }
    } catch(error) {}
    
    if (followedOrgs.length === 0) {
      container.innerHTML = '<p style="color:var(--muted);text-align:center;padding:40px 0;">Follow organizations to see their posts!</p>';
    } else {
      const followedOrgNames = organizations.filter(o => followedOrgs.includes(o.id)).map(o => o.name);
      const feedPosts = createdPosts.filter(p => followedOrgNames.includes(p.org));
      if (feedPosts.length === 0) {
        container.innerHTML = '<p style="color:var(--muted);text-align:center;padding:40px 0;">No posts yet from followed organizations</p>';
      } else {
        container.innerHTML = feedPosts.map(post => {
          const org = organizations.find(o => o.name === post.org);
          const imageHTML = post.image ? `<img src="${post.image}" alt="${post.title}">` : `<div class="poster-img" style="background:linear-gradient(135deg,#bfdbfe,#ddd6fe);">üéâ ${post.title}</div>`;
          return `<article class="poster" style="background:linear-gradient(180deg,#ffffff,#f1f5f9);border:2px solid rgba(255,255,255,0.8);"><div class="meta"><div><div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;cursor:pointer;" onclick="showOrgProfile(${org?.id})"><div style="width:32px;height:32px;border-radius:8px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-size:1.2rem;">${org?.icon || 'üèõÔ∏è'}</div><span style="color:#1e293b;font-weight:600;">${post.org}</span></div><h3 style="color:#1e293b;font-weight:700;margin:0 0 5px 0;">${post.title}</h3><div class="small" style="color:#475569;">${post.date}</div></div></div>${imageHTML}<div><p style="color:#475569;margin:15px 0;">${post.description}</p><div class="actions"><div><button class="icon-btn" onclick="toggleSave(${post.id}, this)">‚ù§ Save</button>${post.eventTime ? `<button class="icon-btn" onclick="addToEvents('${post.title}', '${post.eventTime}')">üìÖ Add Event</button>` : ''}<button class="icon-btn" onclick="shareFlyer('${post.title}')">üîó Share</button></div><button class="btn" onclick="openDetails('${post.title}', this)">View</button></div></div></article>`;
        }).join('');
      }
    }
  }
  
  async function loadPopularContent(container) {
    try {
      const response = await fetch('http://localhost:8080/api/flyers/popular', { credentials: 'include' });
      if (response.ok) {
        const flyers = await response.json();
        if (flyers.length === 0) {
          container.innerHTML = '<p style="color:var(--muted);text-align:center;padding:40px 0;">No popular flyers yet</p>';
        } else {
          container.innerHTML = flyers.map(flyer => {
            const org = organizations.find(o => o.id === flyer.orgId);
            return `<article class="poster" style="background:linear-gradient(180deg,#ffffff,#f1f5f9);border:2px solid rgba(255,255,255,0.8);"><div class="meta"><div>${org ? `<h3 style="margin:0 0 12px 0;cursor:pointer;display:flex;align-items:center;gap:8px;" onclick="showOrgProfile(${org.id})"><div style="width:28px;height:28px;border-radius:6px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-size:1rem;">${org.icon}</div><span>${org.name}</span></h3>` : ''}<div class="small" style="color:#475569;">üî• Popularity: ${flyer.popularityScore}</div></div></div><div><p style="color:#475569;margin:15px 0;">${flyer.flyerAdvert}</p><div class="actions"><div><button class="icon-btn" onclick="toggleSave(${flyer.id}, this)">‚ù§ Save</button><button class="icon-btn" onclick="shareFlyer('${org?.name || 'Event'}')">üîó Share</button></div><button class="btn" onclick="openDetails('${org?.name || 'Event'}', this)">View</button></div></div></article>`;
          }).join('');
        }
      } else {
        container.innerHTML = '<p style="color:var(--muted);text-align:center;padding:40px 0;">Unable to load popular flyers</p>';
      }
    } catch(error) {
      container.innerHTML = '<p style="color:var(--muted);text-align:center;padding:40px 0;">Backend offline. Popular flyers unavailable.</p>';
    }
  }
  
  async function loadTrendingContent(container) {
    try {
      const response = await fetch('http://localhost:8080/api/flyers/trending', { credentials: 'include' });
      if (response.ok) {
        const flyers = await response.json();
        if (flyers.length === 0) {
          container.innerHTML = '<p style="color:var(--muted);text-align:center;padding:40px 0;">No trending flyers yet</p>';
        } else {
          container.innerHTML = flyers.map(flyer => {
            const org = organizations.find(o => o.id === flyer.orgId);
            return `<article class="poster" style="background:linear-gradient(180deg,#ffffff,#f1f5f9);border:2px solid rgba(255,255,255,0.8);"><div class="meta"><div>${org ? `<h3 style="margin:0 0 12px 0;cursor:pointer;display:flex;align-items:center;gap:8px;" onclick="showOrgProfile(${org.id})"><div style="width:28px;height:28px;border-radius:6px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-size:1rem;">${org.icon}</div><span>${org.name}</span></h3>` : ''}<div class="small" style="color:#475569;">üìà Trending</div></div></div><div><p style="color:#475569;margin:15px 0;">${flyer.flyerAdvert}</p><div class="actions"><div><button class="icon-btn" onclick="toggleSave(${flyer.id}, this)">‚ù§ Save</button><button class="icon-btn" onclick="shareFlyer('${org?.name || 'Event'}')">üîó Share</button></div><button class="btn" onclick="openDetails('${org?.name || 'Event'}', this)">View</button></div></div></article>`;
          }).join('');
        }
      } else {
        container.innerHTML = '<p style="color:var(--muted);text-align:center;padding:40px 0;">Unable to load trending flyers</p>';
      }
    } catch(error) {
      container.innerHTML = '<p style="color:var(--muted);text-align:center;padding:40px 0;">Backend offline. Trending flyers unavailable.</p>';
    }
  }
  
  // Initialize page
  checkAuth();
  loadSavedFlyersFromBackend();
  loadFollowedOrgsFromBackend();
  
  // Render initial clubs on page load
  document.addEventListener('DOMContentLoaded', () => {
    const feed = document.getElementById('mainFeed');
    const title = feed.querySelector('div');
    const footer = feed.querySelector('.footer-note');
    const clubsHTML = organizations.map(org => renderClubCard(org)).join('');
    feed.innerHTML = title.outerHTML + clubsHTML + footer.outerHTML;
  });
</script>
</body>
</html>
